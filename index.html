<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ‰‹æ©Ÿè³¼ç‰©å•†åŸ</title>
<style>
body { font-family:"Microsoft JhengHei", Arial, sans-serif; margin:0; padding:0; background:#f5f5f5; }
header { background:#4CAF50; color:white; padding:1.2em; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.2);}
.container { width:95%; max-width:1200px; margin:1.5em auto; }
.categories { display:flex; gap:0.4em; flex-wrap:wrap; margin-bottom:1em; justify-content:center; }
.category-btn { padding:0.5em 1em; background:#eee; border:none; cursor:pointer; border-radius:20px; transition:0.3s; font-weight:500; font-size:0.9em; }
.category-btn.active, .category-btn:hover { background:#4CAF50; color:white; box-shadow:0 2px 5px rgba(0,0,0,0.2);}
.products { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:0.8em; }
.product-card { background:white; border-radius:8px; padding:0.8em; box-shadow:0 2px 10px rgba(0,0,0,0.1); display:flex; flex-direction:column; font-size:0.9em; height:340px; overflow:hidden; }
.product-card img { width:100%; height:140px; object-fit:cover; border-radius:6px; transition:0.3s; }
.product-card h3 { margin:0.4em 0 0.2em 0; font-size:1em; }
.product-card p { margin:0.2em 0; font-size:0.85em; color:#555; }
.product-card .price { font-weight:bold; color:#E91E63; margin-top:0.4em; }
.quantity-control { display:flex; align-items:center; justify-content:center; margin:0.3em 0; }
.quantity-control button { width:28px; height:28px; margin:0 3px; border:none; background:#4CAF50; color:white; border-radius:4px; cursor:pointer; }
.quantity-control span { min-width:18px; text-align:center; display:inline-block; }
.add-cart-icon { font-size:1.2em; cursor:pointer; margin-left:6px; color:#E91E63; }
.cart { position:fixed; right:15px; bottom:75px; background:#E91E63; color:white; padding:0.9em 1em; border-radius:50%; cursor:pointer; font-weight:bold; font-size:1.4em; box-shadow:0 2px 10px rgba(0,0,0,0.3); }
#cartBar { position:fixed; left:0; bottom:0; width:100%; background:#4CAF50; color:white; display:flex; justify-content:space-between; align-items:center; padding:0.8em 1em; font-weight:bold; font-size:0.95em; cursor:pointer; border-top-left-radius:12px; border-top-right-radius:12px; display:none; }
#cartBar span { display:flex; align-items:center; gap:0.5em; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:flex-start; padding-top:5%; z-index:9999; }
.modal-content { background:white; padding:1.5em; border-radius:12px; max-height:90%; overflow-y:auto; width:95%; position:relative; font-size:0.9em; }
.modal-close { position:absolute; top:10px; right:12px; cursor:pointer; color:red; font-weight:bold; font-size:1.2em; }
#cartItems div { padding:0.3em 0; border-bottom:1px solid #eee; }
#cartItems div:last-child { border:none; }
select, input { width:100%; padding:0.5em; margin:0.2em 0; border-radius:6px; border:1px solid #ccc; font-size:0.9em; }
button#checkoutBtn { width:100%; padding:0.6em; margin-top:0.6em; border:none; border-radius:8px; background:#4CAF50; color:white; font-weight:bold; cursor:pointer; font-size:1em; }
button#checkoutBtn:hover { background:#45a049; }
#qrcodeContainer { text-align:center; margin-top:1em; }
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
<header>
  <h1>æ‰‹æ©Ÿè³¼ç‰©å•†åŸ</h1>
  <p id="greeting">æ‚¨å¥½, æœƒå“¡</p>
</header>

<div class="container">
  <div class="categories" id="categoryContainer"></div>
  <div class="products" id="productContainer"></div>
</div>

<div class="cart" id="cartBtn">ğŸ›’</div>
<div id="cartBar">
  <span id="cartInfo">ğŸ›’ 0 ä»¶ | 0 å…ƒ</span>
  <span>æŸ¥çœ‹è³¼ç‰©è»Š</span>
</div>

<div class="modal" id="cartModal">
  <div class="modal-content">
    <span class="modal-close" id="cartClose">&times;</span>
    <h3>è³¼ç‰©è»Š</h3>
    <div id="cartItems"></div>
    <p>ç¸½é¡ï¼š<span id="cartTotal">0</span> å…ƒ</p>

    <h4>ä»˜æ¬¾æ–¹å¼</h4>
    <select id="paymentMethod">
      <option value="ç¾é‡‘">ç¾é‡‘</option>
      <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
      <option value="Line Pay">Line Pay</option>
    </select>

    <h4>å–è²¨æ–¹å¼</h4>
    <select id="deliveryMethod">
      <option value="è‡ªå–">è‡ªå–</option>
      <option value="å¤–é€">å¤–é€</option>
    </select>

    <div id="selfPickup" style="display:none;">
      <p>é¸æ“‡å–è²¨é–€å¸‚</p>
      <select id="pickupStore"></select>
    </div>

    <div id="deliveryForm" style="display:none;">
      <p>è«‹è¼¸å…¥æ”¶ä»¶è³‡è¨Š</p>
      <input type="text" id="receiverName" placeholder="å§“å"><br>
      <input type="text" id="receiverPhone" placeholder="é›»è©±"><br>
      <input type="text" id="receiverAddress" placeholder="åœ°å€"><br>
    </div>

    <button id="checkoutBtn">ç¢ºèªçµå¸³</button>
    <div id="qrcodeContainer"></div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyARYofq8yCKee6DgIg25zeMoVVjkTihuhBFxGPptBrDKU_OZPMI2SlMFnBNT-iH77E/exec";
let products=[], categories=[], cart=[], userId="", userName="", pickupStores=[];

// ======= LIFF åˆå§‹åŒ– =======
async function initLIFF(){
  await liff.init({ liffId: "2008573741-WGE2G7lZ" });
  if(liff.isLoggedIn()){
    const profile = await liff.getProfile();
    userId = profile.userId; userName = profile.displayName;
    document.getElementById("greeting").textContent = `${userName} æ‚¨å¥½`;
  } else liff.login();
}

// ======= æŠ“ç”¢å“å’Œé–€å¸‚ =======
async function fetchProducts(){
  const res = await fetch(API_URL + "?action=products");
  products = await res.json();
  categories = [...new Set(products.map(p=>p['é¡åˆ¥']))];
  renderCategories();
  renderProducts(categories[0]);

  const storeRes = await fetch(API_URL + "?action=stores");
  pickupStores = await storeRes.json();
  const storeSelect = document.getElementById("pickupStore");
  pickupStores.forEach(s=>{ const opt = document.createElement("option"); opt.value=s; opt.textContent=s; storeSelect.appendChild(opt); });
}

// ======= é¡¯ç¤ºåˆ†é¡ =======
function renderCategories(){
  const container = document.getElementById("categoryContainer");
  container.innerHTML="";
  categories.forEach(cat=>{
    const btn = document.createElement("button");
    btn.textContent=cat; btn.className="category-btn";
    btn.onclick=()=>{ document.querySelectorAll(".category-btn").forEach(b=>b.classList.remove("active")); btn.classList.add("active"); renderProducts(cat);}
    container.appendChild(btn);
  });
  if(container.firstChild) container.firstChild.classList.add("active");
}

// ======= é¡¯ç¤ºå•†å“ =======
function renderProducts(category){
  const container = document.getElementById("productContainer");
  container.innerHTML="";
  products.filter(p=>p['é¡åˆ¥']===category).forEach(p=>{
    const card = document.createElement("div"); card.className="product-card";
    card.innerHTML=`
      <img src="${p['å•†å“ç…§ç‰‡']||''}" alt="${p['å•†å“åç¨±']}">
      <h3>${p['å•†å“åç¨±']}</h3>
      <p>${p['ç‰¹è‰²èªªæ˜']||''}</p>
      <p>å–®ä½ï¼š${p['å–®ä½']}</p>
      <p class="price">${p['å”®åƒ¹']} å…ƒ</p>
      <p class="quantity-control">
        <button onclick="changeQty('${p['å•†å“åç¨±']}', -1)">-</button>
        <span id="qty-${p['å•†å“åç¨±']}">1</span>
        <button onclick="changeQty('${p['å•†å“åç¨±']}', 1)">+</button>
        <span class="add-cart-icon" onclick="addToCartWithAnimation('${p['å•†å“åç¨±']}', this)">ğŸ›’</span>
      </p>
    `;
    container.appendChild(card);
  });
}

// ======= æ•¸é‡æ§åˆ¶ =======
function changeQty(name, delta){
  const span = document.getElementById(`qty-${name}`);
  let qty = parseInt(span.textContent); qty+=delta; if(qty<1) qty=1; span.textContent=qty;
}

// ======= åŠ å…¥è³¼ç‰©è»Šå‹•ç•« =======
function addToCartWithAnimation(name, btn){
  const qty = parseInt(document.getElementById(`qty-${name}`).textContent);
  const product = products.find(p=>p['å•†å“åç¨±']===name);
  const exist = cart.find(c=>c.name===name);
  if(exist) exist.quantity+=qty; else cart.push({name, price:parseInt(product['å”®åƒ¹']), quantity:qty, category:product['é¡åˆ¥']});

  const img = btn.closest(".product-card").querySelector("img");
  const imgRect = img.getBoundingClientRect();
  const cartRect = document.getElementById("cartBtn").getBoundingClientRect();
  const flyImg = img.cloneNode(true);
  flyImg.style.position="fixed"; flyImg.style.left=imgRect.left+"px"; flyImg.style.top=imgRect.top+"px";
  flyImg.style.width=imgRect.width+"px"; flyImg.style.height=imgRect.height+"px"; flyImg.style.transition="all 0.8s ease-in-out"; flyImg.style.zIndex=1000;
  document.body.appendChild(flyImg);
  const dx = cartRect.left - imgRect.left + "px"; const dy = cartRect.top - imgRect.top + "px";
  requestAnimationFrame(()=>{ flyImg.style.transform=`translate(${dx},${dy}) scale(0.2)`; flyImg.style.opacity=0; });
  flyImg.addEventListener("transitionend", ()=>{ document.body.removeChild(flyImg); updateCartBar(); });
}

// ======= è³¼ç‰©è»Šæ¢æ›´æ–° =======
function updateCartBar(){
  const cartBar = document.getElementById("cartBar");
  if(cart.length===0){ cartBar.style.display="none"; return; }
  const totalQty = cart.reduce((sum,i)=>sum+i.quantity,0);
  const totalAmt = cart.reduce((sum,i)=>sum+i.quantity*i.price,0);
  document.getElementById("cartInfo").textContent = `ğŸ›’ ${totalQty} ä»¶ | ${totalAmt} å…ƒ`;
  cartBar.style.display="flex";
}

// ======= renderCart() =======
function renderCart(){
  const container = document.getElementById("cartItems");
  container.innerHTML = "";
  
  if(cart.length === 0){
    container.innerHTML = "<p style='text-align:center;color:#555;'>è³¼ç‰©è»Šæ˜¯ç©ºçš„</p>";
    document.getElementById("cartTotal").textContent = "0";
    updateCartBar(); 
    return;
  }

  let total = 0;
  cart.forEach(item => {
    const subtotal = item.price * item.quantity;
    total += subtotal;
    const div = document.createElement("div");
    div.textContent = `${item.name} ${item.quantity} x ${item.price} = ${subtotal} å…ƒ`;
    container.appendChild(div);
  });

  document.getElementById("cartTotal").textContent = total;
  updateCartBar();
}

// ======= è³¼ç‰©è»Šé–‹é—œ =======
const cartBtn = document.getElementById("cartBtn");
const cartBar = document.getElementById("cartBar");
const cartModal = document.getElementById("cartModal");
const cartClose = document.getElementById("cartClose");
cartBtn.onclick=()=>{ renderCart(); cartModal.style.display="flex"; }
cartBar.onclick=()=>{ renderCart(); cartModal.style.display="flex"; }
cartClose.onclick=()=>{ cartModal.style.display="none"; }

// ======= å–è²¨æ–¹å¼åˆ‡æ› =======
document.getElementById("deliveryMethod").onchange=function(){
  const val=this.value;
  if(val==="è‡ªå–"){ document.getElementById("selfPickup").style.display="block"; document.getElementById("deliveryForm").style.display="none"; }
  else{ document.getElementById("selfPickup").style.display="none"; document.getElementById("deliveryForm").style.display="block"; }
}

// ======= çµå¸³æŒ‰éˆ•äº‹ä»¶ =======
document.getElementById("checkoutBtn").onclick = async function(){
  if(cart.length === 0){
    alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„");
    return;
  }

  const totalAmount = cart.reduce((sum, i) => sum + i.price * i.quantity, 0);
  const deliveryMethod = document.getElementById("deliveryMethod").value;
  let receiverName="", receiverPhone="", receiverAddress="", pickupStore="";

  if(deliveryMethod === "å¤–é€"){
    receiverName = document.getElementById("receiverName").value;
    receiverPhone = document.getElementById("receiverPhone").value;
    receiverAddress = document.getElementById("receiverAddress").value;
    if(!receiverName || !receiverPhone || !receiverAddress){
      alert("è«‹å®Œæ•´å¡«å¯«æ”¶ä»¶è³‡è¨Š");
      return;
    }
  } else {
    pickupStore = document.getElementById("pickupStore").value;
  }

  const paymentMethod = document.getElementById("paymentMethod").value;
  const data = {
    userId, userName, totalAmount, paymentMethod, deliveryMethod,
    receiverName, receiverPhone, receiverAddress, pickupStore, items: cart
  };

  try {
    console.log("é€å‡ºè³‡æ–™ï¼š", data);

    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    if(!res.ok){
      throw new Error(`HTTP éŒ¯èª¤ï¼Œç‹€æ…‹ç¢¼ï¼š${res.status}`);
    }

    let result;
    try{
      result = await res.json(); 
    } catch(e){
      throw new Error("ä¼ºæœå™¨å›å‚³é JSON æ ¼å¼");
    }

    alert("è¨‚å–®å®Œæˆï¼Œå–®è™Ÿï¼š" + result.orderId);

    const qrURL = `https://ä½ çš„ç¶²ç«™/order.html?orderId=${result.orderId}`;
    document.getElementById("qrcodeContainer").innerHTML = "";
    new QRCode(document.getElementById("qrcodeContainer"), { text: qrURL, width:180, height:180 });

    if(liff){
      liff.shareTargetPicker([{
        type: 'text',
        text: `è¨‚å–®è™Ÿï¼š${result.orderId}\nç¸½é¡ï¼š${totalAmount} å…ƒ\nå–è²¨ï¼š${pickupStore || '-'}\næƒæ QR Code æŸ¥çœ‹æ˜ç´°ï¼š${qrURL}`
      }]).then(()=>{ console.log('å·²åˆ†äº«è‡³ LINE èŠå¤©å®¤'); })
        .catch(err=>console.error(err));
    }

    cart.length = 0;
    renderCart();
    updateCartBar();

  } catch(err){
    console.error("é€å‡ºè¨‚å–®éŒ¯èª¤ï¼š", err);
    alert("è¨‚å–®é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
  }
}

// ======= åˆå§‹åŒ– =======
initLIFF();
fetchProducts();
</script>
</body>
</html>



















