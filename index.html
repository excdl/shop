<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç”Ÿé®®è”¬æœè³¼ç‰©å•†åŸ</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
<style>
/* ===========================
   å…¨ç«™ä¸»é¡Œè‰²ï¼šé¦¬å¡é¾ç£šç´…ç³»
   =========================== */
:root {
  --primary: #E8A29B;      /* é¦¬å¡é¾ç£šç´… */
  --primary-dark: #d88982;
  --accent: #4CAF50;       /* åŠ å…¥æˆåŠŸç¶  */
  --bg: #FCEFEA;           /* èƒŒæ™¯ç²‰æ©™ */
  --card-border: #F6C8C3;
  --text-dark: #444;
}

/* =========================== BODY =========================== */
body{
    font-family:"Microsoft JhengHei",Arial,sans-serif;
    margin:0;padding:0;
    background:var(--bg);
}

/* =========================== HEADER =========================== */
header{
    background:var(--primary);
    color:white;
    padding:1.2em;
    text-align:center;
    box-shadow:0 2px 5px rgba(0,0,0,0.15);
}
header h1{ margin:0;font-size:1.6em; }
header p{ margin:0.3em 0 0 0;font-size:0.95em; }

.container{
    width:95%;
    max-width:1200px;
    margin:1.5em auto;
}

/* =========================== Category =========================== */
.categories{
    display:flex;
    gap:0.4em;
    flex-wrap:wrap;
    margin-bottom:1em;
    justify-content:center;
}

.category-btn{
    padding:0.5em 1em;
    background:#fff;
    border:1px solid var(--primary);
    color:var(--primary);
    cursor:pointer;
    border-radius:20px;
    transition:0.3s;
    font-weight:500;
    font-size:0.9em;
}

.category-btn:hover{
    background:var(--primary);
    color:white;
}
.category-btn.active{
    background:var(--primary);
    color:white;
    box-shadow:0 2px 6px rgba(0,0,0,0.25);
}

/* =========================== å•†å“å¡ç‰‡ =========================== */
.products{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
    gap:0.8em;
}

.product-card{
    background:white;
    border-radius:10px;
    padding:0.8em;
    box-shadow:0 2px 10px rgba(0,0,0,0.08);
    display:flex;
    flex-direction:column;
    transition:0.3s;
    position:relative;
    border:2px solid var(--card-border);
}

.product-card:hover{
    transform:translateY(-3px);
    box-shadow:0 3px 14px rgba(0,0,0,0.15);
}

.product-card img{
    width:100%;
    height:140px;
    object-fit:cover;
    border-radius:6px;
    transition:0.3s;
}
.product-card:hover img{
    transform:scale(1.04);
}

.product-card h3{ margin:0.4em 0 0.2em 0; }
.product-card p{ margin:0.2em 0;color:#555;font-size:0.85em; }

.price{
    font-weight:bold;
    color:var(--primary-dark);
    margin-top:0.4em;
}

/* =========================== æ•¸é‡æ§åˆ¶ =========================== */
.quantity-control{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:6px;
    margin:0.4em 0;
}

.quantity-control button{
    background:var(--primary);
    border:none;
    color:white;
    width:28px;height:28px;
    border-radius:6px;
    cursor:pointer;
}

/* =========================== ğŸ›ï¸ åŠ å…¥è³¼ç‰©è»Š =========================== */
.add-cart{
    width:38px;
    height:38px;
    border-radius:10px;
    background:var(--primary);
    color:white;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:1.3em;
    border:none;
    cursor:pointer;
    transition:0.3s;
    box-shadow:0 2px 6px rgba(0,0,0,0.25);
}

/* åŠ å…¥å¾Œç¶ è‰²æç¤º */
.add-cart.active{
    background:var(--accent);
    animation: cartBounce 0.35s ease-out, cartGlow 0.6s ease-out;
}

.add-cart:active{
    transform:scale(0.85);
}

/* åŠ å…¥æˆåŠŸå½ˆè·³ */
@keyframes cartBounce{
  0%{ transform:scale(1); }
  30%{ transform:scale(1.22); }
  55%{ transform:scale(0.9); }
  75%{ transform:scale(1.05); }
  100%{ transform:scale(1); }
}

/* ç™¼äº®æ•ˆæœ */
@keyframes cartGlow{
  0%{ box-shadow:0 0 0 rgba(76,175,80,0); }
  50%{ box-shadow:0 0 12px rgba(76,175,80,0.8); }
  100%{ box-shadow:0 0 0 rgba(76,175,80,0); }
}

/* =========================== æµ®å‹•è³¼ç‰©è»Šæ¢ =========================== */
#cartBar{
    position:fixed;
    left:0;bottom:0;width:100%;
    background:var(--primary);
    color:white;
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:0.9em 1em;
    box-shadow:0 -2px 8px rgba(0,0,0,0.2);
    font-weight:bold;
    z-index:998;
    border-top-left-radius:15px;
    border-top-right-radius:15px;
    display:none;
}

#cartBar button{
    background:white;
    color:var(--primary);
    border:none;
    padding:0.45em 0.9em;
    font-weight:bold;
    border-radius:8px;
    cursor:pointer;
}
#cartBar button:hover{
    background:#f0f0f0;
}

/* =========================== Modal =========================== */
.modal{
    display:none;
    position:fixed;
    top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.6);
    justify-content:center;
    align-items:flex-start;
    padding-top:5%;
    z-index:9999;
}

.modal-content{
    background:white;
    padding:1.5em;
    border-radius:14px;
    max-height:90%;
    overflow-y:auto;
    width:95%;
    position:relative;
}

.modal-close{
    position:absolute;
    top:10px;right:12px;
    cursor:pointer;color:red;
    font-weight:bold;font-size:1.2em;
}

#checkoutBtn{
    background:var(--primary);
    border:none;
    padding:0.65em;
    border-radius:10px;
    color:white;
    font-size:1em;
    width:100%;
}
#checkoutBtn:hover{
    background:var(--primary-dark);
}

/* =========================== åŠ å…¥è³¼ç‰©è»Šé£›è¡Œå‹•ç•« =========================== */
.fly-item{
    position:fixed;
    width:40px;
    height:40px;
    border-radius:50%;
    z-index:5000;
    pointer-events:none;
    transition:transform 0.7s cubic-bezier(.55,.06,.68,.19), opacity 0.8s;
}

/* =========================== RWD =========================== */
@media(max-width:600px){
    .products{
        grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
    }
    .product-card img{
        height:120px;
    }
    header h1{ font-size:1.4em; }
    header p{ font-size:0.85em; }
}
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
<header>
<h1>ç”Ÿé®®è”¬æœè³¼ç‰©å•†åŸ</h1>
<p id="greeting">æ‚¨å¥½, æœƒå“¡</p>
</header>

<div class="container">
<div class="categories" id="categoryContainer"></div>
<div class="products" id="productContainer"></div>
</div>

<div class="cart" id="cartBtn">ğŸ›’</div>
<div id="cartBar">
  <span id="cartInfo">ğŸ›’ 0 ä»¶ | 0 å…ƒ</span>
  <span>æŸ¥çœ‹è³¼ç‰©è»Š</span>
</div>

<div class="modal" id="cartModal">
  <div class="modal-content">
    <span class="modal-close" id="cartClose">&times;</span>
    <h3>è³¼ç‰©è»Š</h3>
    <div id="cartItems"></div>
    <p>ç¸½é¡ï¼š<span id="cartTotal">0</span> å…ƒ</p>

    <h4>ä»˜æ¬¾æ–¹å¼</h4>
    <select id="paymentMethod">
      <option value="ç¾é‡‘">ç¾é‡‘</option>
      <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
      <option value="Line Pay">Line Pay</option>
    </select>

<h4>å–è²¨æ–¹å¼</h4>
<select id="deliveryMethod">
  <option value="" selected disabled>è«‹é¸æ“‡å–è²¨æ–¹å¼</option>
  <option value="è‡ªå–">è‡ªå–</option>
  <option value="å¤–é€">å¤–é€</option>
</select>

<div id="selfPickup" style="display:none;">
  <p>é¸æ“‡å–è²¨é–€å¸‚</p>
  <select id="pickupStore"></select>
</div>

<div id="deliveryForm" style="display:none;">
  <p>è«‹è¼¸å…¥æ”¶ä»¶è³‡è¨Š</p>
  <input type="text" id="receiverName" placeholder="å§“å"><br>
  <input type="text" id="receiverPhone" placeholder="é›»è©±"><br>
  <input type="text" id="receiverAddress" placeholder="åœ°å€"><br>
</div>


    <button id="checkoutBtn">âœ… çµå¸³</button>
    <div id="qrcodeContainer"></div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxMkKxl6kFI8Wlo0BE3S1MWJml6kATkUq_dY9qRIsEHnNfbfsDLBrcgbrnXY6vHIXvS/exec";
let products=[], categories=[], cart=[], userId="", userName="";
let pickupStores = [];

// LIFF ç™»å…¥
async function initLIFF(){
  await liff.init({ liffId:"2008573741-WGE2G7lZ" });
  if(liff.isLoggedIn()){
    const profile = await liff.getProfile();
    userId = profile.userId;
    userName = profile.displayName;
    document.getElementById("greeting").textContent = `${userName} æ‚¨å¥½`;
  } else liff.login();
}

// å–å¾—å•†å“èˆ‡é–€å¸‚
async function fetchProducts(){
  const res = await fetch(API_URL+"?action=products");
  products = await res.json();
  categories = [...new Set(products.map(p => p['é¡åˆ¥']))].filter(Boolean);
  renderCategories();
  renderProducts(categories[0]);

  const storeRes = await fetch(API_URL+"?action=stores");
  pickupStores = await storeRes.json();
  const storeSelect = document.getElementById("pickupStore");
  pickupStores.forEach(s=>{ 
    const opt=document.createElement("option"); 
    opt.value=s; 
    opt.textContent=s; 
    storeSelect.appendChild(opt); 
  });
}

// é¡¯ç¤ºåˆ†é¡æŒ‰éˆ•
function renderCategories(){
  const container = document.getElementById("categoryContainer");
  container.innerHTML="";
  categories.forEach(cat=>{
    const btn=document.createElement("button");
    btn.textContent=cat;
    btn.className="category-btn";
    btn.onclick=()=>{ 
      document.querySelectorAll(".category-btn").forEach(b=>b.classList.remove("active")); 
      btn.classList.add("active"); 
      renderProducts(cat);
    }
    container.appendChild(btn);
  });
  if(container.firstChild) container.firstChild.classList.add("active");
}

// é¡¯ç¤ºå•†å“
function renderProducts(category){
  const container = document.getElementById("productContainer");
  container.innerHTML="";
  products.filter(p => p['é¡åˆ¥'] === category).forEach(p => {
    const card=document.createElement("div");
    card.className="product-card";
    card.innerHTML=`
      <img src="${p['å•†å“ç…§ç‰‡']}" alt="${p['å•†å“åç¨±']}">
      <h3>${p['å•†å“åç¨±']}</h3>
      <p>${p['ç‰¹è‰²èªªæ˜'] || ''}</p>
      <p>å–®ä½ï¼š${p['å–®ä½']}</p>
      <p class="price">${p['å”®åƒ¹']} å…ƒ</p>
      <p class="quantity-control">
        <button onclick="changeQty('${p['å•†å“åç¨±']}',-1)">-</button>
        <span id="qty-${p['å•†å“åç¨±']}">1</span>
        <button onclick="changeQty('${p['å•†å“åç¨±']}',1)">+</button>
        <button class="add-cart" onclick="addToCartWithAnimation('${p['å•†å“åç¨±']}', this)">ğŸ›’</button>
      </p>
    `;
    container.appendChild(card);
  });
}

// æ•¸é‡èª¿æ•´
function changeQty(name, delta){
  const span = document.getElementById(`qty-${name}`);
  let qty = parseInt(span.textContent);
  qty += delta;
  if(qty<1) qty=1;
  span.textContent=qty;
}

// åŠ å…¥è³¼ç‰©è»Šå‹•ç•«
function addToCartWithAnimation(name, btn){
  const qty = parseInt(document.getElementById(`qty-${name}`).textContent);
  const product = products.find(p=>p['å•†å“åç¨±']===name);
  const existIndex = cart.findIndex(c=>c.name===name);

  const img = btn.closest(".product-card").querySelector("img");
  const imgRect = img.getBoundingClientRect();
  const cartRect = document.getElementById("cartBtn").getBoundingClientRect();

  if(existIndex !== -1){ 
    cart.splice(existIndex, 1);
    btn.classList.remove("active");
  } else { 
    cart.push({name, price: parseInt(product['å”®åƒ¹']), quantity: qty, category: product['é¡åˆ¥']});
    btn.classList.add("active");
  }

  const flyImg = img.cloneNode(true);
  flyImg.style.position = "fixed";
  flyImg.style.left = imgRect.left + "px";
  flyImg.style.top = imgRect.top + "px";
  flyImg.style.width = imgRect.width + "px";
  flyImg.style.height = imgRect.height + "px";
  flyImg.style.transition = "all 0.6s ease-in-out";
  flyImg.style.zIndex = 1000;
  flyImg.style.opacity = 0.8;
  document.body.appendChild(flyImg);

  const dx = cartRect.left - imgRect.left + "px";
  const dy = cartRect.top - imgRect.top + "px";
  requestAnimationFrame(()=>{ flyImg.style.transform = `translate(${dx},${dy}) scale(0.2)`; flyImg.style.opacity = 0.5; });
  flyImg.addEventListener("transitionend", ()=>{ document.body.removeChild(flyImg); updateCartBar(); });

  updateCartBar();
}

// æ›´æ–°è³¼ç‰©è»Šæ¢
function updateCartBar(){
  const cartBar = document.getElementById("cartBar");
  if(cart.length===0){ cartBar.style.display="none"; return; }
  const totalQty = cart.reduce((sum,i)=>sum+i.quantity,0);
  const totalAmt = cart.reduce((sum,i)=>sum+i.quantity*i.price,0);
  document.getElementById("cartInfo").textContent=`ğŸ›’ ${totalQty} ä»¶ | ${totalAmt} å…ƒ`;
  cartBar.style.display="flex";
}

// æ‰“é–‹è³¼ç‰©è»Š
const cartBtn=document.getElementById("cartBtn");
const cartBar=document.getElementById("cartBar");
const cartModal=document.getElementById("cartModal");
const cartClose=document.getElementById("cartClose");
cartBtn.onclick=()=>{ renderCart(); cartModal.style.display="flex"; }
cartBar.onclick=()=>{ renderCart(); cartModal.style.display="flex"; }
cartClose.onclick=()=>{ cartModal.style.display="none"; }

function renderCart(){
  const container=document.getElementById("cartItems");
  container.innerHTML="";
  let total=0;
  cart.forEach(item=>{
    const subtotal=item.price*item.quantity;
    total+=subtotal;
    const div=document.createElement("div");
    div.textContent=`${item.name} ${item.quantity} x ${item.price} = ${subtotal} å…ƒ`;
    container.appendChild(div);
  });
  document.getElementById("cartTotal").textContent=total;
  updateCartBar();
}

// å–è²¨æ–¹å¼åˆ‡æ›
document.getElementById("deliveryMethod").onchange = function(){
  const val = this.value;
  if(val === "è‡ªå–"){ 
    document.getElementById("selfPickup").style.display = "block"; 
    document.getElementById("deliveryForm").style.display = "none"; 
  } else if(val === "å¤–é€"){ 
    document.getElementById("selfPickup").style.display = "none"; 
    document.getElementById("deliveryForm").style.display = "block"; 
  } else {
    document.getElementById("selfPickup").style.display = "none";
    document.getElementById("deliveryForm").style.display = "none";
  }
}

// çµå¸³
document.getElementById("checkoutBtn").onclick = async function(){
  if(cart.length===0){ alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„"); return; }

  const totalAmount = cart.reduce((sum,i)=>sum+i.price*i.quantity,0);
  const deliveryMethod = document.getElementById("deliveryMethod").value;
  if(!deliveryMethod){ alert("è«‹é¸æ“‡å–è²¨æ–¹å¼"); return; }

  let shippingFee=0, receiverName="", receiverPhone="", receiverAddress="", pickupStore="";

  if(deliveryMethod==="å¤–é€"){
    if(totalAmount<1500){ alert("å¤–é€é‡‘é¡éœ€é”1500å…ƒä»¥ä¸Š"); return; }
    receiverName=document.getElementById("receiverName").value;
    receiverPhone=document.getElementById("receiverPhone").value;
    receiverAddress=document.getElementById("receiverAddress").value;
    if(!receiverName||!receiverPhone||!receiverAddress){ alert("è«‹å®Œæ•´å¡«å¯«æ”¶ä»¶è³‡è¨Š"); return; }

    // ğŸ”¹ è‡ªå‹•æ›´æ–°æœƒå“¡è³‡æ–™
    const res = await fetch(API_URL, {
      method:'POST',
      body: JSON.stringify({
        userId,
        userName,
        name: receiverName,
        phone: receiverPhone,
        address: receiverAddress
      })
    });
    const result = await res.json();

    // âœ… å°‡æ›´æ–°å¾Œè³‡æ–™å¸¶å…¥å‰å°è¡¨å–®
    if(result.user){
      document.getElementById("receiverName").value = result.user.name;
      document.getElementById("receiverPhone").value = result.user.phone;
      document.getElementById("receiverAddress").value = result.user.address;
    }
  } else {
    pickupStore=document.getElementById("pickupStore").value;
    if(!pickupStore){ alert("è«‹é¸æ“‡å–è²¨é–€å¸‚"); return; }
  }

  const paymentMethod=document.getElementById("paymentMethod").value;

  const data={
    userId,userName,totalAmount,shippingFee,paymentMethod,
    deliveryMethod,receiverName,receiverPhone,receiverAddress,pickupStore,items:cart
  };

  // ä¸‹å–®åˆ° GAS
  const resOrder=await fetch(API_URL,{method:'POST',body:JSON.stringify(data)});
  const resultOrder=await resOrder.json();
  alert("è¨‚å–®å®Œæˆï¼Œå–®è™Ÿï¼š"+resultOrder.orderId);

  // ç”¢ç”Ÿ QRCode
  document.getElementById("qrcodeContainer").innerHTML="";
  const orderDetailUrl = `${window.location.origin}?page=pickup&orderId=${resultOrder.orderId}`;
  new QRCode(document.getElementById("qrcodeContainer"), {text: orderDetailUrl,width:128,height:128});
  const link = document.createElement("a");
  link.href = orderDetailUrl;
  link.textContent = "é»æ“ŠæŸ¥çœ‹è¨‚å–®æ˜ç´°";
  link.target = "_blank";
  link.style.display = "block";
  link.style.textAlign = "center";
  link.style.marginTop = "0.5em";
  document.getElementById("qrcodeContainer").appendChild(link);

  cart=[]; updateCartBar(); cartModal.style.display="none";
}


// åˆå§‹åŒ–
initLIFF();
fetchProducts();
</script>

</body>
</html>





































































































































































































































