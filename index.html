<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LINE 購物商城</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body { font-family: Arial; background:#f7f7f7; margin:0; padding:20px; }
header { text-align:center; margin-bottom:20px; }
#userInfo { font-weight:bold; margin-bottom:10px; }

.products { display:flex; flex-wrap:wrap; gap:20px; justify-content:center; }
.product-card { background:white; border-radius:12px; width:180px; padding:10px; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
.product-card img { width:100%; height:120px; object-fit:cover; border-radius:8px; }
.product-card h3 { font-size:16px; margin:8px 0 4px; }
.product-card p { margin:4px 0; }
.product-card input { width:50px; text-align:center; margin-top:6px; }
.product-card button { margin-top:6px; padding:6px 12px; border:none; background:#3498db; color:white; border-radius:6px; cursor:pointer; }
.product-card button:hover { background:#2980b9; }

.cart-summary { background:white; padding:15px; border-radius:12px; margin-top:20px; max-width:400px; margin-left:auto; margin-right:auto; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.1);}
.cart-summary p { margin:6px 0; }
.cart-summary button { margin-top:10px; padding:10px 20px; font-size:16px; background:#2ecc71; color:white; border:none; border-radius:8px; cursor:pointer; }
.cart-summary button:hover { background:#27ae60; }

</style>
</head>
<body>

<header>
    <h1>LINE 購物商城</h1>
    <div id="userInfo">正在取得使用者資訊...</div>
</header>

<div class="products" id="productList">
    <!-- 商品卡片會動態生成 -->
</div>

<div class="cart-summary" id="cartSummary">
    <p>總數量: <span id="totalQty">0</span></p>
    <p>總金額: $<span id="totalAmount">0</span></p>
    <button id="btnCheckout">結帳</button>
</div>

<script>
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbwm0MFQC-4Y32tb-82sqe-ZJgu9a_JFT5mkoq_gbvyajPFHuPvhFIjt4tPcYBfeUfwv/exec";
let userId="", userName="";
let cart = [];

// 商品範例資料
const products = [
    {id:"P001", name:"零食禮盒", price:120, category:"零食", img:"https://picsum.photos/180/120?random=1"},
    {id:"P002", name:"水果茶飲", price:80, category:"飲料", img:"https://picsum.photos/180/120?random=2"},
    {id:"P003", name:"手工餅乾", price:60, category:"零食", img:"https://picsum.photos/180/120?random=3"},
    {id:"P004", name:"咖啡豆", price:200, category:"飲料", img:"https://picsum.photos/180/120?random=4"},
];

// LIFF 初始化
async function initLiff(){
    await liff.init({ liffId:"2008573741-WGE2G7lZ" });
    if(!liff.isLoggedIn()) await liff.login();
    const profile = await liff.getProfile();
    userId = profile.userId;
    userName = profile.displayName;
    document.getElementById("userInfo").textContent = `${userName} 您好`;
    renderProducts();
}

// 渲染商品
function renderProducts(){
    const container = document.getElementById("productList");
    container.innerHTML = "";
    products.forEach(p => {
        const card = document.createElement("div");
        card.className = "product-card";
        card.innerHTML = `
            <img src="${p.img}" alt="${p.name}">
            <h3>${p.name}</h3>
            <p>價格: $${p.price}</p>
            <input type="number" min="0" value="0" id="qty-${p.id}">
            <button onclick="addToCart('${p.id}')">加入購物車</button>
        `;
        container.appendChild(card);
    });
}

// 加入購物車
function addToCart(id){
    const qty = Number(document.getElementById(`qty-${id}`).value);
    if(qty<=0){ Swal.fire("請輸入數量"); return; }

    const product = products.find(p=>p.id===id);
    const exist = cart.find(c=>c.id===id);
    if(exist) exist.qty += qty;
    else cart.push({...product, qty});

    updateCartSummary();
}

// 更新購物車統計
function updateCartSummary(){
    const totalQty = cart.reduce((sum,c)=>sum+c.qty,0);
    const totalAmount = cart.reduce((sum,c)=>sum+c.qty*c.price,0);
    document.getElementById("totalQty").textContent = totalQty;
    document.getElementById("totalAmount").textContent = totalAmount;
}

// 結帳
document.getElementById("btnCheckout").onclick = async () => {
    if(cart.length===0){ Swal.fire("購物車是空的"); return; }

    const receiverName = prompt("請輸入收件人姓名");
    const receiverPhone = prompt("請輸入收件人電話");
    const receiverAddress = prompt("請輸入收件人地址");
    const paymentMethod = prompt("付款方式 (貨到付款 / LINE Pay)");

    if(!receiverName || !receiverPhone || !receiverAddress || !paymentMethod){ Swal.fire("請完整填寫收件資訊"); return; }

    try{
        for(const item of cart){
            const data = {
                userId, userName,
                orderTime: new Date().toISOString(),
                productCategory: item.category,
                productId: item.id,
                productName: item.name,
                quantity: item.qty,
                price: item.price,
                subtotal: item.qty*item.price,
                receiverName, receiverPhone, receiverAddress, paymentMethod,
                remark:""
            };
            await fetch(API_ENDPOINT,{method:"POST", body:JSON.stringify(data)});
        }
        Swal.fire("結帳成功!");
        cart=[]; updateCartSummary();
        renderProducts();
    }catch(err){
        Swal.fire("結帳失敗", err.message,"error");
    }
}

window.onload = initLiff;
</script>

</body>
</html>


