<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>專業購物商城</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f9f9f9; }
header { background:#4CAF50; color:white; padding:1em; text-align:center; }
.container { width:90%; max-width:1200px; margin:2em auto; }
.categories { display:flex; gap:1em; flex-wrap:wrap; margin-bottom:2em; }
.category-btn { padding:0.5em 1em; background:#eee; border:none; cursor:pointer; border-radius:4px; }
.category-btn.active { background:#4CAF50; color:white; }
.products { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:1em; }
.product-card { background:white; border-radius:4px; padding:1em; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
.product-card h3 { margin:0.5em 0 0.3em 0; font-size:1.1em; }
.product-card p { margin:0.2em 0; font-size:0.9em; color:#555; }
.product-card .price { font-weight:bold; color:#E91E63; margin-top:0.5em; }
button.add-cart { margin-top:0.5em; padding:0.3em 0.5em; background:#4CAF50; color:white; border:none; border-radius:3px; cursor:pointer; }
#cart { margin-top:2em; }
#cart table { width:100%; border-collapse: collapse; }
#cart th, #cart td { border:1px solid #ccc; padding:0.5em; text-align:center; }
#checkoutModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
#checkoutModal .modal-content { background:white; padding:2em; border-radius:5px; width:90%; max-width:500px; }
#checkoutModal input, #checkoutModal select { width:100%; margin:0.3em 0 1em 0; padding:0.5em; }
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<header>
  <h1>專業購物商城</h1>
  <p id="greeting">您好, 會員</p>
</header>
<div class="container">
  <div class="categories" id="categoryContainer"></div>
  <div class="products" id="productContainer"></div>
  <div id="cart">
    <h2>購物車</h2>
    <table>
      <thead>
        <tr><th>商品名稱</th><th>單價</th><th>數量</th><th>小計</th><th>操作</th></tr>
      </thead>
      <tbody id="cartBody"></tbody>
    </table>
    <button onclick="openCheckout()">結帳</button>
  </div>
</div>

<!-- 結帳彈窗 -->
<div id="checkoutModal">
  <div class="modal-content">
    <h3>結帳資訊</h3>
    <label>會員姓名<input id="memberName" type="text"></label>
    <label>連絡電話<input id="memberPhone" type="text"></label>
    <label>送貨地址<input id="memberAddress" type="text"></label>
    <label>取貨方式
      <select id="delivery" onchange="togglePickup()">
        <option value="自取">自取</option>
        <option value="外送">外送</option>
      </select>
    </label>
    <div id="pickupDiv" style="display:none;">
      <label>取貨門市
        <select id="pickupStore"></select>
      </label>
    </div>
    <label>付款方式
      <select id="payment">
        <option value="現金">現金</option>
        <option value="轉帳 / ATM">轉帳 / ATM</option>
        <option value="LINE Pay">LINE Pay</option>
        <option value="貨到付款">貨到付款</option>
        <option value="刷卡">刷卡</option>
      </select>
    </label>
    <button onclick="confirmOrder()">確認下單</button>
    <button onclick="closeCheckout()">取消</button>
    <div id="modalContent"></div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzzGPRpcLpeg6CjJbOjD5QJbT1ev6vhvPmlHLFfvX_6-mGOfhCvAURlduHCQi9VFTl4/exec"; // <-- 替換為你的 GAS URL
let products = [];
let categories = [];
let cart = [];
let USER_ID = "";

// LIFF 初始化
async function initLIFF() {
  await liff.init({ liffId: "2008573741-WGE2G7lZ" });
  if (liff.isLoggedIn()) {
    const profile = await liff.getProfile();
    setGreeting(profile.displayName);
    USER_ID = profile.userId;
  } else {
    liff.login();
  }
}

function setGreeting(userName){
  document.getElementById("greeting").textContent = `${userName} 您好`;
}

// 取得商品清單
async function fetchProducts(){
  try{
    const res = await fetch(API_URL);
    if(!res.ok) throw new Error("網路錯誤");
    products = await res.json();
    categories = [...new Set(products.map(p => p['類別']))];
    renderCategories();
    renderProducts(categories[0]);
  }catch(e){
    console.error(e);
    alert("無法取得商品清單");
  }
}

// 顯示類別按鈕
function renderCategories(){
  const container = document.getElementById("categoryContainer");
  container.innerHTML = "";
  categories.forEach(cat => {
    const btn = document.createElement("button");
    btn.textContent = cat;
    btn.className = "category-btn";
    btn.onclick = ()=> { 
      document.querySelectorAll(".category-btn").forEach(b=>b.classList.remove("active")); 
      btn.classList.add("active"); 
      renderProducts(cat); 
    };
    container.appendChild(btn);
  });
  if(container.firstChild) container.firstChild.classList.add("active");
}

// 顯示商品
function renderProducts(category){
  const container = document.getElementById("productContainer");
  container.innerHTML = "";
  products.filter(p=>p['類別']===category).forEach(p=>{
    const card = document.createElement("div");
    card.className = "product-card";
    card.innerHTML = `
      <h3>${p['商品名稱']}</h3>
      <p>${p['特色說明'] || ''}</p>
      <p class="price">${p['售價'] || ''} / ${p['單位'] || ''}</p>
      <button class="add-cart" onclick='addToCart(${JSON.stringify(p)})'>加入購物車</button>
    `;
    container.appendChild(card);
  });
}

// 加入購物車
function addToCart(product){
  const existing = cart.find(c=>c['商品名稱']===product['商品名稱']);
  if(existing){ existing.qty += 1; }
  else { cart.push({...product, qty:1}); }
  renderCart();
}

// 顯示購物車
function renderCart(){
  const tbody = document.getElementById("cartBody");
  tbody.innerHTML = "";
  cart.forEach((item,i)=>{
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${item['商品名稱']}</td>
      <td>${item['售價']}</td>
      <td>${item.qty}</td>
      <td>${item.qty * parseFloat(item['售價'].replace(/[^0-9.-]+/g,""))}</td>
      <td><button onclick="removeFromCart(${i})">刪除</button></td>
    `;
    tbody.appendChild(row);
  });
}

function removeFromCart(index){ cart.splice(index,1); renderCart(); }

// 開啟結帳
function openCheckout(){ document.getElementById("checkoutModal").style.display="flex"; togglePickup(); }
function closeCheckout(){ document.getElementById("checkoutModal").style.display="none"; }

// 取貨方式切換
async function togglePickup(){
  const delivery = document.getElementById("delivery").value;
  const pickupDiv = document.getElementById("pickupDiv");
  if(delivery==="自取"){
    pickupDiv.style.display = "block";
    await loadPickupStores();
  }else{
    pickupDiv.style.display = "none";
  }
}

// 取得門市
async function loadPickupStores(){
  const res = await fetch(`${API_URL}?market=1`);
  const stores = await res.json();
  const select = document.getElementById("pickupStore");
  select.innerHTML = "";
  stores.forEach(store=>{
    const opt = document.createElement("option");
    opt.value = store;
    opt.textContent = store;
    select.appendChild(opt);
  });
}

// 確認下單
async function confirmOrder(){
  const name = document.getElementById("memberName").value;
  const phone = document.getElementById("memberPhone").value;
  const address = document.getElementById("memberAddress").value;
  const delivery = document.getElementById("delivery").value;
  const payment = document.getElementById("payment").value;
  const total = cart.reduce((s,i)=>s + parseFloat(i['售價'].replace(/[^0-9.-]+/g,"")) * i.qty,0);
  let pickupStore = "";
  if(delivery==="外送" && total<1500){ return alert("外送訂單需滿 NT$1500"); }
  if(delivery==="自取") pickupStore = document.getElementById("pickupStore").value;

  const res = await fetch(API_URL,{
    method:"POST",
    body: JSON.stringify({
      userId:USER_ID,
      name, phone, address,
      delivery, pickupStore, payment,
      cart, total, orderTime:new Date()
    })
  });
  const data = await res.json();
  alert("訂單完成");

  document.getElementById("modalContent").innerHTML = `<h3>取貨 QR Code</h3><img src="${data.qrCode || ''}" style="width:220px;">`;
}

initLIFF();
fetchProducts();
</script>
</body>
</html>








