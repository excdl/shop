<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åœ˜è³¼å•†åŸ</title>
<style>
body{font-family:"Microsoft JhengHei",Arial,sans-serif;margin:0;padding:0;background:#fdf6f0;}
header{background:#FFA07A;color:white;padding:1.2em;text-align:center;box-shadow:0 2px 5px rgba(0,0,0,0.2);}
header h1{margin:0;font-size:1.6em;}
header p{margin:0.3em 0 0 0;font-size:0.95em;}
.container{width:95%;max-width:1200px;margin:1.5em auto;}
.categories{display:flex;gap:0.4em;flex-wrap:wrap;margin-bottom:1em;justify-content:center;}
.category-btn{padding:0.5em 1em;background:#ffe6d6;border:none;cursor:pointer;border-radius:20px;transition:0.3s;font-weight:500;font-size:0.9em;}
.category-btn:hover{background:#FFA07A;color:white;}
.category-btn.active{background:#FFA07A;color:white;box-shadow:0 2px 5px rgba(0,0,0,0.2);}
.products{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:0.8em;}
.product-card{background:white;border-radius:8px;padding:0.8em;box-shadow:0 2px 10px rgba(0,0,0,0.1);display:flex;flex-direction:column;transition:0.3s;position:relative;overflow:hidden;font-size:0.9em;}
.product-card:hover{transform:translateY(-2px);box-shadow:0 3px 12px rgba(0,0,0,0.2);}
.product-card img{width:100%;height:140px;object-fit:cover;border-radius:6px;transition:0.3s;}
.product-card:hover img{transform:scale(1.03);}
.product-card h3{margin:0.4em 0 0.2em 0;font-size:1em;}
.product-card p{margin:0.2em 0;font-size:0.85em;color:#555;}
.product-card .price{font-weight:bold;color:#FF7F50;margin-top:0.4em;}

/* æ•¸é‡æ§åˆ¶ */
.quantity-control{
  margin:0.4em 0;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:5px;
}
.quantity-control button{
  width:36px;
  height:36px;
  border:none;
  background:#FFA07A;
  color:white;
  border-radius:6px;
  cursor:pointer;
  font-size:1em;
  transition: transform 0.15s;
}
.quantity-control span{
  width:36px;
  height:36px;
  line-height:36px;
  text-align:center;
  display:inline-block;
  background:#eee;
  border-radius:6px;
  font-weight:bold;
  transition: transform 0.15s;
}
.quantity-control .pop { transform: scale(1.2); }

/* åŠ å…¥è³¼ç‰©è»ŠæŒ‰éˆ• */
.add-cart {
  width:auto;
  height:36px;
  padding:0 10px;
  border-radius:8px;
  background:#FFA07A;
  color:white;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:1.2em;
  border:none;
  cursor:pointer;
  transition: background 0.3s, transform 0.15s, box-shadow 0.3s;
  box-shadow:0 2px 6px rgba(0,0,0,0.3);
}
.add-cart.active { background:#B0E57C !important; box-shadow:0 2px 8px rgba(0,0,0,0.5);}
.add-cart.bounce { transform: scale(1.2); }

/* è³¼ç‰©è»Šåœ–ç¤º */
.cart{position:fixed;right:15px;bottom:75px;background:#FFA07A;color:white;padding:0.9em 1em;border-radius:50%;cursor:pointer;font-weight:bold;font-size:1.4em;box-shadow:0 2px 10px rgba(0,0,0,0.3);transition:0.3s;z-index:999;}
.cart:hover{transform:scale(1.1);}
#cartBar{position:fixed;left:0;bottom:0;width:100%;background:#FFA07A;color:white;display:flex;justify-content:space-between;align-items:center;padding:0.8em 1em;box-shadow:0 -2px 5px rgba(0,0,0,0.2);font-weight:bold;font-size:0.95em;cursor:pointer;z-index:998;display:none;border-top-left-radius:12px;border-top-right-radius:12px;}
#cartBar span{display:flex;align-items:center;gap:0.5em;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);justify-content:center;align-items:flex-start;padding-top:5%;z-index:9999;}
.modal-content{background:white;padding:1.5em;border-radius:12px;max-height:90%;overflow-y:auto;width:95%;position:relative;font-size:0.9em;display:flex;flex-direction:column;}
.modal-close{position:absolute;top:10px;right:12px;cursor:pointer;color:red;font-weight:bold;font-size:1.2em;}
#cartItems div{padding:0.3em 0;border-bottom:1px solid #eee;}
#cartItems div:last-child{border:none;}
select,input{width:100%;padding:0.5em;margin:0.2em 0;border-radius:6px;border:1px solid #ccc;font-size:0.9em;}
button#checkoutBtn{width:100%;padding:0.6em;margin-top:0.6em;border:none;border-radius:8px;background:#B0E57C;color:white;font-weight:bold;cursor:pointer;font-size:1em;}
button#checkoutBtn:hover{background:#9ED36A;}
#qrcodeContainer{text-align:center;margin-top:1em;}
@media (max-width:600px){
.products{grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:0.6em;}
.product-card img{height:120px;}
.category-btn{padding:0.5em 0.8em;font-size:0.85em;}
header h1{font-size:1.4em;}
header p{font-size:0.85em;}
}
</style>
</head>
<body>
<header>
<h1>å°ˆæ¥­åœ˜è³¼å•†åŸ</h1>
<p id="greeting">æ‚¨å¥½, æœƒå“¡</p>
</header>

<div class="container">
<div class="categories" id="categoryContainer"></div>
<div class="products" id="productContainer"></div>
</div>

<div class="cart" id="cartBtn">ğŸ›’</div>
<div id="cartBar">
  <span id="cartInfo">ğŸ›’ 0 ä»¶ | 0 å…ƒ</span>
  <span>æŸ¥çœ‹è³¼ç‰©è»Š</span>
</div>

<div class="modal" id="cartModal">
  <div class="modal-content">
    <span class="modal-close" id="cartClose">&times;</span>
    <h3>è³¼ç‰©è»Š</h3>
    <div id="cartItems"></div>
    <p>ç¸½é¡ï¼š<span id="cartTotal">0</span> å…ƒ</p>

    <h4>ä»˜æ¬¾æ–¹å¼</h4>
    <select id="paymentMethod">
      <option value="ç¾é‡‘">ç¾é‡‘</option>
      <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
      <option value="Line Pay">Line Pay</option>
    </select>

    <h4>å–è²¨æ–¹å¼</h4>
    <select id="deliveryMethod">
      <option value="è‡ªå–">è‡ªå–</option>
      <option value="å¤–é€">å¤–é€</option>
    </select>

    <div id="selfPickup" style="display:block;">
      <p>é¸æ“‡å–è²¨é–€å¸‚</p>
      <select id="pickupStore"></select>
    </div>

    <div id="deliveryForm" style="display:none;">
      <p>è«‹è¼¸å…¥æ”¶ä»¶è³‡è¨Š</p>
      <input type="text" id="receiverName" placeholder="å§“å"><br>
      <input type="text" id="receiverPhone" placeholder="é›»è©±"><br>
      <input type="text" id="receiverAddress" placeholder="åœ°å€"><br>
    </div>

    <button id="checkoutBtn">âœ… çµå¸³</button>
    <div id="qrcodeContainer"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://static.line-scdn.net/liff/edge/2.24/sdk.js"></script>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzLZ78tdVd7vu16rgrSL806OjrpUQ1oGR41RqOVDcPNwqLMGcTql6QDxMixNYEO2UZi/exec";
let products=[], categories=[], cart=[], userId="", userName="";
let pickupStores = [];

// LIFF åˆå§‹åŒ–
liff.init({ liffId: "2008573741-WGE2G7lZ" }).then(() => {
    if (!liff.isLoggedIn()) {
        liff.login();
    } else {
        liff.getProfile().then(profile => {
            userName = profile.displayName;
            userId = profile.userId;
            document.getElementById("greeting").textContent = `${userName} æ‚¨å¥½`;
        }).catch(err => console.error("LIFF getProfile éŒ¯èª¤:", err));
    }
}).catch(err => console.error("LIFF init éŒ¯èª¤:", err));

// å–å¾—ç”¢å“æ¸…å–® & å–è²¨é–€å¸‚
async function fetchProducts(){
    try {
        const res = await fetch(API_URL+"?action=products");
        products = await res.json();
        categories = [...new Set(products.map(p=>p['é¡åˆ¥']))];
        renderCategories();
        if(categories.length>0) renderProducts(categories[0]);

        const storeRes = await fetch(API_URL+"?action=stores");
        pickupStores = await storeRes.json();
        const storeSelect = document.getElementById("pickupStore");
        pickupStores.forEach(s=>{ 
            const opt=document.createElement("option"); 
            opt.value=s; 
            opt.textContent=s; 
            storeSelect.appendChild(opt); 
        });
    } catch(err) {
        console.error("fetchProducts éŒ¯èª¤:", err);
        alert("ç„¡æ³•å–å¾—ç”¢å“æˆ–é–€å¸‚è³‡æ–™");
    }
}

function renderCategories(){
    const container = document.getElementById("categoryContainer");
    container.innerHTML="";
    categories.forEach(cat=>{
        const btn=document.createElement("button");
        btn.textContent=cat;
        btn.className="category-btn";
        btn.onclick=()=>{ 
            document.querySelectorAll(".category-btn").forEach(b=>b.classList.remove("active")); 
            btn.classList.add("active"); 
            renderProducts(cat);
        }
        container.appendChild(btn);
    });
    if(container.firstChild) container.firstChild.classList.add("active");
}

function renderProducts(category){
    const container = document.getElementById("productContainer");
    container.innerHTML="";
    products.filter(p=>p['é¡åˆ¥']===category).forEach(p=>{
        const card=document.createElement("div");
        card.className="product-card";

        // æ¨™ç±¤
        const labelContainer = document.createElement("div");
        labelContainer.style.position="absolute";
        labelContainer.style.top="8px";
        labelContainer.style.left="8px";
        labelContainer.style.display="flex";
        labelContainer.style.flexDirection="column";
        labelContainer.style.gap="4px";

        if(p['æ¨™ç±¤']){
            p['æ¨™ç±¤'].split(",").forEach(l=>{
                const span=document.createElement("span");
                span.textContent = l.trim();
                span.style.background="#FFA07A";
                span.style.color="white";
                span.style.fontSize="0.7em";
                span.style.padding="2px 6px";
                span.style.borderRadius="6px";
                span.style.fontWeight="bold";
                labelContainer.appendChild(span);
            });
        }
        card.appendChild(labelContainer);

        const safeName = encodeURIComponent(p['å•†å“åç¨±']);
        card.innerHTML += `
          <img src="${p['å•†å“ç…§ç‰‡']||''}" alt="${p['å•†å“åç¨±']}">
          <h3>${p['å•†å“åç¨±']}</h3>
          <p>${p['ç‰¹è‰²èªªæ˜']||''}</p>
          <p>å–®ä½ï¼š${p['å–®ä½']}</p>
          <p class="price">${p['å”®åƒ¹']} å…ƒ</p>
          <p class="quantity-control">
            <button onclick="changeQty('${safeName}',-1)">-</button>
            <span data-name="${safeName}">1</span>
            <button onclick="changeQty('${safeName}',1)">+</button>
            <button class="add-cart" onclick="addToCartWithAnimation('${safeName}', this)">ğŸ›’</button>
          </p>
        `;
        container.appendChild(card);
    });
}

function changeQty(nameEncoded, delta){
    const name = decodeURIComponent(nameEncoded);
    const span = document.querySelector(`[data-name="${nameEncoded}"]`);
    if(!span) return;
    let qty = parseInt(span.textContent);
    qty += delta;
    if(qty<1) qty=1;
    span.textContent = qty;
    span.classList.add("pop");
    setTimeout(()=>{ span.classList.remove("pop"); },150);
}

function addToCartWithAnimation(nameEncoded, btn){
    const name = decodeURIComponent(nameEncoded);
    const span = document.querySelector(`[data-name="${nameEncoded}"]`);
    if(!span) return;
    const qty = parseInt(span.textContent);
    const product = products.find(p=>p['å•†å“åç¨±']===name);
    if(!product) return;
    const exist = cart.find(c=>c.name===name);
    if(exist) exist.quantity += qty;
    else cart.push({name, price:Number(product['å”®åƒ¹']), quantity:qty, category:product['é¡åˆ¥']});

    btn.classList.add("active","bounce");
    setTimeout(()=>{ btn.classList.remove("bounce"); },150);
    updateCartBar();
}

function updateCartBar(){
    const cartBar = document.getElementById("cartBar");
    if(cart.length===0){ cartBar.style.display="none"; return; }
    const totalQty = cart.reduce((sum,i)=>sum+i.quantity,0);
    const totalAmt = cart.reduce((sum,i)=>sum+i.quantity*i.price,0);
    document.getElementById("cartInfo").textContent=`ğŸ›’ ${totalQty} ä»¶ | ${totalAmt} å…ƒ`;
    cartBar.style.display="flex";
}

const cartBtn=document.getElementById("cartBtn");
const cartBar=document.getElementById("cartBar");
const cartModal=document.getElementById("cartModal");
const cartClose=document.getElementById("cartClose");
cartBtn.onclick=()=>{ renderCart(); cartModal.style.display="flex"; }
cartBar.onclick=()=>{ renderCart(); cartModal.style.display="flex"; }
cartClose.onclick=()=>{ cartModal.style.display="none"; }

function renderCart(){
    const container=document.getElementById("cartItems");
    container.innerHTML="";
    let total=0;
    cart.forEach(item=>{
        const subtotal=item.price*item.quantity;
        total+=subtotal;
        const div=document.createElement("div");
        div.textContent=`${item.name} ${item.quantity} x ${item.price} = ${subtotal} å…ƒ`;
        container.appendChild(div);
    });
    document.getElementById("cartTotal").textContent=total;
    updateCartBar();
}

document.getElementById("deliveryMethod").onchange = function(){
    const val = this.value;
    if(val === "è‡ªå–"){ 
        document.getElementById("selfPickup").style.display = "block"; 
        document.getElementById("deliveryForm").style.display = "none"; 
    } else { 
        document.getElementById("selfPickup").style.display = "none"; 
        document.getElementById("deliveryForm").style.display = "block"; 
    }
}

document.getElementById("checkoutBtn").onclick = async function(){
    if(cart.length===0){ alert("è³¼ç‰©è»Šç‚ºç©º"); return; }
    const orderData = {
        userId,
        userName,
        deliveryMethod: document.getElementById("deliveryMethod").value,
        pickupStore: document.getElementById("pickupStore").value,
        receiverName: document.getElementById("receiverName").value,
        receiverPhone: document.getElementById("receiverPhone").value,
        receiverAddress: document.getElementById("receiverAddress").value,
        paymentMethod: document.getElementById("paymentMethod").value,
        totalAmount: cart.reduce((sum,i)=>sum+i.quantity*i.price,0),
        items: cart
    };
    try {
        const res = await fetch(API_URL, {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify(orderData)
        });
        const data = await res.json();
        alert("ä¸‹å–®æˆåŠŸï¼Œè¨‚å–®ç·¨è™Ÿï¼š"+data.orderId);

        // ç”Ÿæˆ QR Code
        document.getElementById("qrcodeContainer").innerHTML="";
        QRCode.toCanvas(document.getElementById("qrcodeContainer"), window.location.href+"?orderId="+data.orderId, {width:180}, function(error){
            if(error) console.error(error);
        });

        cart=[];
        updateCartBar();
        renderCart();
    } catch(err) {
        console.error("checkout éŒ¯èª¤:", err);
        alert("ä¸‹å–®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
    }
}

// å•Ÿå‹•æŠ“å–ç”¢å“
fetchProducts();
</script>
</body>
</html>











