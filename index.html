<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>LIFF 購物網站</title>
<style>
body { font-family: Arial; padding: 10px; }
.product { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
.product img { width: 100px; height: 100px; }
button { margin-top: 5px; }
.modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
.modal-content { background-color: #fff; margin: 15% auto; padding: 20px; width: 80%; max-width: 400px; border-radius: 5px; }
.close { float: right; font-size: 20px; cursor: pointer; }
</style>
</head>
<body>
<h1>LIFF 購物網站</h1>

<h2>商品列表</h2>
<div id="products"></div>

<h2>購物車</h2>
<div id="cart"></div>
<div>總價：<span id="totalPrice">0</span> 元</div>
<button onclick="showOrderConfirmation()">下單</button>

<!-- 訂單確認 Modal -->
<div id="orderModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h3>訂單確認</h3>
    <div id="orderDetails"></div>
    <div>總價：<span id="confirmTotal">0</span> 元</div>
    <div>
      <label>付款方式：
        <select id="paymentMethod">
          <option value="信用卡">信用卡</option>
          <option value="Line Pay">Line Pay</option>
          <option value="貨到付款">貨到付款</option>
        </select>
      </label>
    </div>
    <button onclick="submitOrder()">確認送出</button>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const LIFF_ID = "2008573741-WGE2G7lZ";
const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbxo2g1xjDFqHqg_PoAS0ChK7YJ1lTofpHSbBw1DERGYyw4_LSaR6_uDN6dnRbS1v855/exec";

let products = [
  { id: 1, name: "商品A", price: 100, image: "https://via.placeholder.com/100?text=商品A" },
  { id: 2, name: "商品B", price: 200, image: "https://via.placeholder.com/100?text=商品B" },
  { id: 3, name: "商品C", price: 300, image: "https://via.placeholder.com/100?text=商品C" }
];

let cart = [];

// ---------------- LIFF 初始化 ----------------
liff.init({ liffId: LIFF_ID }).then(() => {
  if (!liff.isLoggedIn()) liff.login();
  renderProducts();
  renderCart();
});

// ---------------- 商品操作 ----------------
function renderProducts() {
  const productsDiv = document.getElementById('products');
  productsDiv.innerHTML = '';
  products.forEach(p => {
    const div = document.createElement('div');
    div.className = 'product';
    div.innerHTML = `
      <img src="${p.image}" alt="${p.name}">
      <div>${p.name}</div>
      <div>${p.price} 元</div>
      <button onclick="addToCart(${p.id})">加入購物車</button>
    `;
    productsDiv.appendChild(div);
  });
}

function addToCart(productId) {
  const product = products.find(p => p.id === productId);
  const existing = cart.find(item => item.id === productId);
  if (existing) existing.quantity += 1;
  else cart.push({ ...product, quantity: 1 });
  renderCart();
}

function removeFromCart(productId) {
  cart = cart.filter(item => item.id !== productId);
  renderCart();
}

function renderCart() {
  const cartDiv = document.getElementById('cart');
  const totalPriceSpan = document.getElementById('totalPrice');
  cartDiv.innerHTML = '';
  let total = 0;
  cart.forEach(item => {
    total += item.price * item.quantity;
    const div = document.createElement('div');
    div.innerHTML = `${item.name} x ${item.quantity} = ${item.price * item.quantity} 元
                     <button onclick="removeFromCart(${item.id})">刪除</button>`;
    cartDiv.appendChild(div);
  });
  totalPriceSpan.textContent = total;
}

// ---------------- 訂單 Modal ----------------
function showOrderConfirmation() {
  if (cart.length === 0) { alert('購物車是空的！'); return; }
  const orderDetailsDiv = document.getElementById('orderDetails');
  let total = 0;
  orderDetailsDiv.innerHTML = '';
  cart.forEach(item => {
    total += item.price * item.quantity;
    const div = document.createElement('div');
    div.textContent = `${item.name} x ${item.quantity} = ${item.price * item.quantity} 元`;
    orderDetailsDiv.appendChild(div);
  });
  document.getElementById('confirmTotal').textContent = total;
  document.getElementById('orderModal').style.display = 'block';
}

function closeModal() { document.getElementById('orderModal').style.display = 'none'; }

// ---------------- 訂單編號生成 ----------------
function generateOrderId() {
  const timestamp = Date.now().toString();
  const random = Math.floor(Math.random()*1000).toString().padStart(3,'0');
  return `ORD-${timestamp}-${random}`;
}

// ---------------- 前端檢測 Webhook ----------------
async function preCheckOrder(payload) {
  try {
    const testRes = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ test: true })
    });
    const testText = await testRes.text();
    try {
      const testData = JSON.parse(testText);
      if (testData.status !== 'ok') {
        alert(`Web App 測試失敗，訊息：${JSON.stringify(testData)}`);
        console.error('Web App 測試失敗', testData);
        return false;
      }
    } catch(err) {
      alert(`Web App 回傳非 JSON 或解析錯誤：\n${testText}`);
      console.error('Web App JSON 解析錯誤', testText);
      return false;
    }
    return true;
  } catch(err) {
    alert(`無法存取 Web App，Fetch 錯誤：\n${err}`);
    console.error('Web App Fetch 錯誤', err);
    return false;
  }
}

// ---------------- 下單送出 ----------------
async function submitOrder() {
  const payment = document.getElementById('paymentMethod').value;
  liff.getProfile().then(async profile => {
    const payload = { userId: profile.userId, order: cart, paymentMethod: payment, orderId: generateOrderId() };
    const checkOK = await preCheckOrder(payload);
    if (!checkOK) return;

    fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
    .then(async res => {
      const text = await res.text();
      try {
        const data = JSON.parse(text);
        if (data.status === 'ok') {
          alert(`訂單已送出！\n訂單編號: ${payload.orderId}\nLINE 已收到通知`);
          cart = [];
          renderCart();
          closeModal();
        } else {
          alert(`訂單送出失敗，後端訊息：${JSON.stringify(data)}`);
          console.error('後端回傳錯誤', data);
        }
      } catch(err) {
        alert(`訂單送出失敗，解析回傳訊息錯誤：\n${text}`);
        console.error('解析 JSON 失敗', text);
      }
    })
    .catch(err => {
      alert(`訂單送出失敗，Fetch 錯誤：\n${err}`);
      console.error('Fetch 錯誤', err);
    });
  });
}
</script>
</body>
</html>


