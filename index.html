<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LIFF è³¼ç‰©è»Š Demo</title>
<style>
body{font-family: sans-serif;margin:0;padding:0;background:#f5f5f5;}
header{padding:1em;background:#4CAF50;color:white;text-align:center;}
h1{margin:0;font-size:1.5em;}
#categoryContainer{display:flex;flex-wrap:wrap;padding:1em;gap:.5em;justify-content:center;}
.category-btn{padding:.5em 1em;border:none;border-radius:5px;background:#ddd;cursor:pointer;}
.category-btn.active{background:#4CAF50;color:white;}
#productContainer{display:flex;flex-wrap:wrap;gap:1em;padding:1em;justify-content:center;}
.product-card{background:white;padding:1em;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,.2);width:200px;text-align:center;}
.product-card img{width:100%;height:150px;object-fit:cover;border-radius:5px;}
.price{font-weight:bold;margin:0.5em 0;}
.quantity-control{display:flex;align-items:center;justify-content:space-between;margin-top:.5em;}
.quantity-control button{padding:.3em .6em;}
.add-cart{background:#FF9800;color:white;border:none;border-radius:5px;cursor:pointer;}
#cartBar{position:fixed;bottom:0;width:100%;background:#333;color:white;padding:0.5em 1em;display:none;justify-content:space-between;align-items:center;box-shadow:0 -2px 5px rgba(0,0,0,.2);}
#checkoutBtn{padding:.5em 1em;background:#FF5722;color:white;border:none;border-radius:5px;cursor:pointer;}
#qrcodeContainer{text-align:center;padding:1em;}
#deliveryInfo{padding:1em;}
</style>
</head>
<body>

<header>
  <h1 id="greeting">æ­¡è¿ä½¿ç”¨è³¼ç‰©è»Š</h1>
</header>

<div id="categoryContainer"></div>
<div id="productContainer"></div>

<div id="cartBar">
  <span id="cartInfo"></span>
  <button id="checkoutBtn">çµå¸³</button>
</div>

<div id="deliveryInfo">
  <label>ä»˜æ¬¾æ–¹å¼ï¼š
    <select id="paymentMethod">
      <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
      <option value="LinePay">LinePay</option>
      <option value="è²¨åˆ°ä»˜æ¬¾">è²¨åˆ°ä»˜æ¬¾</option>
    </select>
  </label>
  <br><br>
  <label>å–è²¨æ–¹å¼ï¼š
    <select id="deliveryMethod">
      <option value="è‡ªå–">è‡ªå–</option>
      <option value="å¤–é€">å¤–é€</option>
    </select>
  </label>
  <div id="selfPickup">
    <label>å–è²¨é–€å¸‚ï¼š
      <select id="pickupStore"></select>
    </label>
  </div>
  <div id="deliveryForm" style="display:none;">
    <label>æ”¶ä»¶äººå§“åï¼š<input type="text" id="receiverName"></label><br>
    <label>æ”¶ä»¶äººé›»è©±ï¼š<input type="text" id="receiverPhone"></label><br>
    <label>æ”¶ä»¶åœ°å€ï¼š<input type="text" id="receiverAddress"></label>
  </div>
</div>

<div id="qrcodeContainer"></div>

<!-- QRCode.js -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<script>
/* -----------------------------
    å…¨åŸŸè®Šæ•¸
------------------------------*/
const API_URL = "https://script.google.com/macros/s/AKfycbz-RO66nY14tqrkW3YV_UIzHm11VNOH1VteIp73byI_zZuOCOFVK4lEPqd5DLEVkB1h/exec"; // â†æ›æˆä½ çš„ GAS
let products=[],categories=[],cart=[],userId="",userName="",pickupStores=[];

/* -----------------------------
    LIFF åˆå§‹åŒ–
------------------------------*/
async function initLIFF(){
  await liff.init({ liffId:"2008573741-WGE2G7lZ" });
  if(liff.isLoggedIn()){
    const profile = await liff.getProfile();
    userId = profile.userId;
    userName = profile.displayName;
    document.getElementById("greeting").textContent = `${userName} æ‚¨å¥½`;
  } else liff.login();
}

/* -----------------------------
    å„²å­˜æœƒå“¡
------------------------------*/
async function saveCustomer(){
  if(!userId || !userName) return;
  try{
    await fetch(API_URL+"?action=customer",{
      method:"POST",
      body:JSON.stringify({userId,userName,phone:"",address:""})
    });
  }catch(e){console.error(e);}
}

/* -----------------------------
    å–å¾—å•†å“èˆ‡é–€å¸‚
------------------------------*/
async function fetchProductsAndStores(){
  const res = await fetch(API_URL+"?action=products"); products=await res.json();
  categories=[...new Set(products.map(p=>p["é¡åˆ¥"]))];
  renderCategories(); renderProducts(categories[0]);

  const storeRes=await fetch(API_URL+"?action=stores"); pickupStores=await storeRes.json();
  const storeSelect=document.getElementById("pickupStore");
  pickupStores.forEach(store=>{const opt=document.createElement("option"); opt.value=store; opt.textContent=store; storeSelect.appendChild(opt)});
}

/* -----------------------------
    é¡¯ç¤ºåˆ†é¡
------------------------------*/
function renderCategories(){
  const container=document.getElementById("categoryContainer"); container.innerHTML="";
  categories.forEach(cat=>{
    const btn=document.createElement("button"); btn.textContent=cat; btn.className="category-btn";
    btn.onclick=()=>{document.querySelectorAll(".category-btn").forEach(b=>b.classList.remove("active")); btn.classList.add("active"); renderProducts(cat);}
    container.appendChild(btn);
  });
  if(container.firstChild) container.firstChild.classList.add("active");
}

/* -----------------------------
    é¡¯ç¤ºå•†å“
------------------------------*/
function renderProducts(category){
  const container=document.getElementById("productContainer"); container.innerHTML="";
  products.filter(p=>p["é¡åˆ¥"]===category).forEach(p=>{
    const card=document.createElement("div"); card.className="product-card";
    card.innerHTML=`<img src="${p["å•†å“ç…§ç‰‡"]||''}" alt="${p["å•†å“åç¨±"]}"><h3>${p["å•†å“åç¨±"]}</h3><p>${p["ç‰¹è‰²èªªæ˜"]||''}</p><p>å–®ä½ï¼š${p["å–®ä½"]}</p><p class="price">${p["å”®åƒ¹"]} å…ƒ</p>
    <p class="quantity-control"><button onclick="changeQty('${p["å•†å“åç¨±"]}',-1)">-</button><span id="qty-${p["å•†å“åç¨±"]}">1</span><button onclick="changeQty('${p["å•†å“åç¨±"]}',1)">+</button><button class="add-cart" onclick="addToCartWithAnimation('${p["å•†å“åç¨±"]}',this)">ğŸ›’</button></p>`;
    container.appendChild(card);
  });
}

/* -----------------------------
    ä¿®æ”¹æ•¸é‡
------------------------------*/
function changeQty(name,delta){
  const span=document.getElementById("qty-"+name); let qty=parseInt(span.textContent)+delta;
  if(qty<1)qty=1; span.textContent=qty;
}

/* -----------------------------
    åŠ å…¥è³¼ç‰©è»Š
------------------------------*/
function addToCartWithAnimation(name,btn){
  const qty=parseInt(document.getElementById("qty-"+name).textContent);
  const product=products.find(p=>p["å•†å“åç¨±"]===name);
  const existIndex=cart.findIndex(c=>c.name===name);
  const img=btn.closest(".product-card").querySelector("img");
  const imgRect=img.getBoundingClientRect();
  const cartRect=document.getElementById("cartBar").getBoundingClientRect();

  if(existIndex!==-1){ cart.splice(existIndex,1); btn.classList.remove("active"); } 
  else { cart.push({name,price:parseInt(product["å”®åƒ¹"]),quantity:qty,category:product["é¡åˆ¥"]}); btn.classList.add("active"); }

  const flyImg=img.cloneNode(true); flyImg.style.position="fixed"; flyImg.style.left=imgRect.left+"px"; flyImg.style.top=imgRect.top+"px"; flyImg.style.width=imgRect.width+"px"; flyImg.style.height=imgRect.height+"px"; flyImg.style.transition="all 0.6s ease-in-out"; flyImg.style.zIndex=1000; flyImg.style.opacity=0.8; document.body.appendChild(flyImg);

  const dx=cartRect.left-imgRect.left+"px"; const dy=cartRect.top-imgRect.top+"px";
  requestAnimationFrame(()=>{flyImg.style.transform=`translate(${dx},${dy}) scale(0.2)`; flyImg.style.opacity=0.5;});
  flyImg.addEventListener("transitionend",()=>{document.body.removeChild(flyImg);updateCartBar();});
  updateCartBar();
}

/* -----------------------------
    æ›´æ–°è³¼ç‰©è»Š bar
------------------------------*/
function updateCartBar(){
  const cartBar=document.getElementById("cartBar");
  if(cart.length===0){cartBar.style.display="none"; return;}
  const totalQty=cart.reduce((s,i)=>s+i.quantity,0);
  const totalAmt=cart.reduce((s,i)=>s+i.quantity*i.price,0);
  document.getElementById("cartInfo").textContent=`ğŸ›’ ${totalQty} ä»¶ | ${totalAmt} å…ƒ`;
  cartBar.style.display="flex";
}

/* -----------------------------
    ç›£è½å–è²¨æ–¹å¼åˆ‡æ›
------------------------------*/
document.getElementById("deliveryMethod").addEventListener("change",e=>{
  const v=e.target.value;
  document.getElementById("selfPickup").style.display=v==="è‡ªå–"?"block":"none";
  document.getElementById("deliveryForm").style.display=v==="å¤–é€"?"block":"none";
});

/* -----------------------------
    çµå¸³
------------------------------*/
document.getElementById("checkoutBtn").onclick=async function(){
  if(cart.length===0){alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„"); return;}
  const payment=document.getElementById("paymentMethod").value;
  const delivery=document.getElementById("deliveryMethod").value;
  let deliveryInfo={};
  if(delivery==="è‡ªå–"){deliveryInfo.store=document.getElementById("pickupStore").value;}
  else{
    deliveryInfo={receiverName:document.getElementById("receiverName").value.trim(),receiverPhone:document.getElementById("receiverPhone").value.trim(),receiverAddress:document.getElementById("receiverAddress").value.trim()};
    if(!deliveryInfo.receiverName||!deliveryInfo.receiverPhone||!deliveryInfo.receiverAddress){alert("è«‹å®Œæ•´å¡«å¯«æ”¶ä»¶è³‡è¨Š"); return;}
  }

  const order={userId,userName,paymentMethod:payment,deliveryMethod:delivery,...deliveryInfo,items:cart.map(c=>({name:c.name,price:c.price,quantity:c.quantity,category:c.category})),totalAmount:cart.reduce((s,i)=>s+i.price*i.quantity,0)};

  try{
    const res=await fetch(API_URL+"?action=order",{method:"POST",body:JSON.stringify(order)});
    const result=await res.json();
    if(result.message!=="æˆåŠŸ"){alert("ä¸‹å–®å¤±æ•—"); return;}
    showQRCode(result.orderId);
    cart=[]; updateCartBar();
  }catch(err){console.error(err);alert("ä¸‹å–®å¤±æ•—");}
};

/* -----------------------------
    é¡¯ç¤º QRCode
------------------------------*/
function showQRCode(orderId){
  const qrBox=document.getElementById("qrcodeContainer"); qrBox.innerHTML="";
  new QRCode(qrBox,{text:orderId,width:200,height:200});
  const txt=document.createElement("p"); txt.textContent="è¨‚å–®ç·¨è™Ÿï¼š"+orderId; txt.style.fontWeight="bold"; txt.style.marginTop="1em"; qrBox.appendChild(txt);
}

/* -----------------------------
    åˆå§‹åŒ–
------------------------------*/
window.onload=async function(){
  await initLIFF();
  await saveCustomer();
  await fetchProductsAndStores();
};
</script>

<!-- LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</body>
</html>
































































































































